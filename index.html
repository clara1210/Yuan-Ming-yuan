<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>圆明园沉浸式数字展厅</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{background:#000;font-family:Arial;}
.container{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px;}
.model-container{
width:100%;max-width:1000px;height:75vh;border-radius:15px;
overflow:hidden;position:relative;margin-bottom:20px;
box-shadow:0 40px 100px rgba(0,0,0,0.7);}
#modelCanvas{width:100%;height:100%;display:block;}
.loading{
position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
color:#fff;font-size:18px;}
.introduction{
width:100%;max-width:1000px;padding:30px;
text-align:center;font-size:16px;font-weight:bold;
background:rgba(255,255,255,0.95);border-radius:15px;
line-height:1.7;white-space:pre-line;
opacity:0;transition:opacity 0.8s;}
.introduction.show{opacity:1;}
.part-buttons{margin-top:20px;display:flex;gap:10px;}
.part-btn{
background:#b8860b;border:none;color:#fff;
font-weight:bold;padding:10px 18px;
border-radius:6px;cursor:pointer;}
.part-btn:hover{background:#d4af37;}
</style>
</head>

<body>
<div class="container">

<div class="model-container">
<div class="loading" id="loading">沉浸式加载中...</div>
<canvas id="modelCanvas"></canvas>
</div>

<div class="introduction" id="introText"></div>

<div class="part-buttons">
<button class="part-btn" onclick="triggerWater()">午时喷水演示</button>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/RGBELoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>

<script>
let scene,camera,renderer,controls,model;
let autoRotate=true;
let waterGroup;

function init(){

scene=new THREE.Scene();

/* HDR环境 */
new THREE.RGBELoader().load(
'https://threejs.org/examples/textures/equirectangular/royal_esplanade_1k.hdr',
texture=>{
texture.mapping=THREE.EquirectangularReflectionMapping;
scene.environment=texture;
});

/* 背景 */
new THREE.TextureLoader().load('test1.jpg',t=>scene.background=t);

/* 相机 */
camera=new THREE.PerspectiveCamera(60,1,0.1,1000);
camera.position.set(0,1.2,8);

/* 渲染器 */
const container=document.querySelector('.model-container');
renderer=new THREE.WebGLRenderer({canvas:modelCanvas,antialias:true});
renderer.shadowMap.enabled=true;
renderer.physicallyCorrectLights=true;
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(container.clientWidth,container.clientHeight);

/* 灯光 */
scene.add(new THREE.AmbientLight(0xffffff,0.4));
const spot=new THREE.SpotLight(0xffffff,1.6);
spot.position.set(5,15,5);
spot.castShadow=true;
scene.add(spot);

/* 地面 */
const ground=new THREE.Mesh(
new THREE.PlaneGeometry(30,30),
new THREE.ShadowMaterial({opacity:0.3})
);
ground.rotation.x=-Math.PI/2;
ground.position.y=-1.5;
ground.receiveShadow=true;
scene.add(ground);

/* 控制器 */
controls=new THREE.OrbitControls(camera,renderer.domElement);
controls.enableDamping=true;
controls.addEventListener('start',()=>autoRotate=false);
controls.addEventListener('end',()=>autoRotate=true);

/* 模型 */
new THREE.GLTFLoader().load('model.glb',gltf=>{
model=gltf.scene;

model.traverse(obj=>{
if(obj.isMesh){
obj.castShadow=true;
obj.material.metalness=0.95;
obj.material.roughness=0.25;
}
});

scene.add(model);

const box=new THREE.Box3().setFromObject(model);
const center=box.getCenter(new THREE.Vector3());
model.position.sub(center);

startIntroMove();
document.getElementById('loading').style.display='none';
});

window.addEventListener('resize',()=>{
camera.aspect=container.clientWidth/container.clientHeight;
camera.updateProjectionMatrix();
renderer.setSize(container.clientWidth,container.clientHeight);
});
}

/* 开场运镜 */
function startIntroMove(){
let t=0;
function move(){
if(t<1){
t+=0.01;
camera.position.z=8-3*t;
requestAnimationFrame(move);
}
}
move();
}

/* 终极水流系统 */
function triggerWater(){

if(waterGroup) scene.remove(waterGroup);
waterGroup=new THREE.Group();

const count=600;
const geometry=new THREE.BufferGeometry();
const positions=new Float32Array(count*3);
const velocities=[];

for(let i=0;i<count;i++){

positions[i*3]=0;
positions[i*3+1]=0.9;
positions[i*3+2]=0.7;

velocities.push({
x:(Math.random()-0.5)*0.03,
y:0.14+Math.random()*0.05,
z:0.22+Math.random()*0.06
});
}

geometry.setAttribute('position',new THREE.BufferAttribute(positions,3));

const material=new THREE.PointsMaterial({
color:0x66ccff,
size:0.07,
transparent:true,
opacity:0.85
});

const particles=new THREE.Points(geometry,material);
waterGroup.add(particles);

/* 水雾 */
const mistGeo=new THREE.SphereGeometry(0.2,16,16);
const mistMat=new THREE.MeshBasicMaterial({
color:0x99ddff,
transparent:true,
opacity:0.3
});
const mist=new THREE.Mesh(mistGeo,mistMat);
mist.position.set(0,0.9,0.7);
waterGroup.add(mist);

scene.add(waterGroup);

let frame=0;

function animateWater(){

frame++;
const pos=particles.geometry.attributes.position.array;

for(let i=0;i<count;i++){

pos[i*3]+=velocities[i].x;
pos[i*3+1]+=velocities[i].y;
pos[i*3+2]+=velocities[i].z;

velocities[i].y-=0.007;

/* 落地水花 */
if(pos[i*3+1]<-1.4){
velocities[i].y=0;
}
}

particles.geometry.attributes.position.needsUpdate=true;

if(frame<150){
requestAnimationFrame(animateWater);
}else{
scene.remove(waterGroup);
}
}

animateWater();
}

function animate(){
requestAnimationFrame(animate);
if(model && autoRotate) model.rotation.y+=0.002;
controls.update();
renderer.render(scene,camera);
}

init();
animate();
</script>

</body>
</html>
