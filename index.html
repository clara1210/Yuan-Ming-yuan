<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ†æ˜å›­æ„ä»¶3Då±•ç¤º</title>
    <style>
        body { margin: 0; overflow: hidden; background: #fff !important; }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 20px;
            z-index: 100;
            cursor: pointer;
        }
        #model-desc {
            position: fixed;
            bottom: 20px;
            left: 15px;
            right: 15px;
            z-index: 9;
            background: transparent;
            color: #000;
            font-size: 16px;
            line-height: 1.5;
            text-align: left;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0;
        }
        .popup-desc {
            position: fixed;
            top: 20px;
            left: 15px;
            right: 15px;
            z-index: 99;
            background: rgba(255, 255, 255, 0.98);
            color: #000;
            font-size: 15px;
            line-height: 1.5;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            display: none;
        }
        .popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        .popup-close:active { color: #000; }
    </style>
    <!-- å›½å†…é¡¶çº§ç¨³å®šCDNï¼ˆç¡®ä¿Three.jsä¸è¢«æ‹¦æˆªï¼‰ -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.byteintl.com/three.js/0.160.0/three.module.js",
                "three/addons/": "https://cdn.byteintl.com/three.js/0.160.0/examples/jsm/"
            }
        }
    </script>
    <!-- æå‰å¼•å…¥WebGLæ£€æµ‹ï¼ˆé¿å…ä¸å…¼å®¹å¯¼è‡´çš„é™é»˜å¤±è´¥ï¼‰ -->
    <script src="https://cdn.byteintl.com/three.js/0.160.0/examples/jsm/Detector.js"></script>
</head>
<body>
    <div class="loading">åŠ è½½ä¸­...</div>
    <div id="model-desc">
        å®ƒä¸åªæ˜¯ä¸€ä»¶æ–‡ç‰©ï¼Œæ›´æ˜¯ä¸€åº§â€˜ç™¾å¹´æ°´åŠ›é’Ÿâ€™ï¼é©¬é¦–ä½œä¸ºæµ·æ™å ‚åäºŒç”Ÿè‚–æ°´åŠ›é’Ÿçš„æ ¸å¿ƒï¼Œä¸“é—¨å¯¹åº”åˆæ—¶ï¼ˆ11:00-13:00ï¼‰å–·æ°´ï¼Œä¸­è¥¿åˆç’§çš„æ°´åˆ©ä¸è®¡æ—¶æ™ºæ…§ï¼Œåœ¨å®ƒèº«ä¸Šä½“ç°å¾—æ·‹æ¼“å°½è‡´ã€‚
    </div>
    <div class="popup-desc" id="ear-popup">
        <button class="popup-close">&times;</button>
        ä»”ç»†çœ‹ï¼è¿™å¤„æ®‹ç¼ºçš„å³è€³ï¼Œè—ç€ä¸€æ®µåˆ»éª¨é“­å¿ƒçš„å†å²â€”â€”1860å¹´è‹±æ³•è”å†›åŠ«æ åœ†æ˜å›­æ—¶ï¼Œå®ƒè¢«æš´åŠ›æŸæ¯ï¼Œæˆä¸ºæ–‡ç‰©ç™¾å¹´æµç¦»çš„â€œæ— å£°è§è¯è€…â€ã€‚ä»Šå¤©ï¼Œå°±è®©æˆ‘ä»¬ç”¨æ•°å­—æŠ€æœ¯ï¼Œä¸ºå®ƒè¡¥ä¸Šè¿™é“è·¨è¶Šç™¾å¹´çš„â€œä¼¤ç—•â€ã€‚
    </div>
    <div class="popup-desc" id="mane-popup">
        <button class="popup-close">&times;</button>
        è¿™ç»„çµåŠ¨çš„å·æ›²é¬ƒæ¯›ï¼Œç«Ÿå‡ºè‡ªéƒä¸–å®ä¹‹æ‰‹ï¼å®ƒå°†è¥¿æ´‹é›•å¡‘çš„å†™å®ç»†è…»ï¼Œä¸ä¸­å›½é’é“œå·¥è‰ºçš„åšé‡å…¸é›…å®Œç¾èåˆï¼Œæ¯ä¸€ç¼•çº¹è·¯éƒ½è—ç€æ¸…ä»£å®«å»·é€ åŠå¤„çš„å·…å³°æŠ€è‰ºï¼Œå†ç»ç™¾å¹´ä¾æ—§çµåŠ¨é²œæ´»ã€‚
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // ç¬¬ä¸€æ­¥ï¼šæ£€æµ‹WebGLå…¼å®¹æ€§ï¼ˆé¿å…ä¸å…¼å®¹å¯¼è‡´åŠ è½½å¡ä½ï¼‰
        const loadingText = document.querySelector('.loading');
        if (!Detector.webgl) {
            Detector.addGetWebGLMessage();
            loadingText.innerText = 'æ‚¨çš„è®¾å¤‡ä¸æ”¯æŒ3Dæ¸²æŸ“ï¼Œè¯·æ›´æ¢æ‰‹æœº/æµè§ˆå™¨';
            loadingText.style.cursor = 'default';
        } else {
            // å…¨å±€å˜é‡åˆå§‹åŒ–
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0xffffff);
            document.body.appendChild(renderer.domElement);

            // å…‰ç…§ä¼˜åŒ–ï¼ˆæå‡æ¨¡å‹è¯†åˆ«åº¦ï¼‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.6);
            directionalLight1.position.set(3, 3, 3);
            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight2.position.set(-3, -3, -3);
            scene.add(ambientLight, directionalLight1, directionalLight2);

            // å¼¹çª—é€»è¾‘
            const earPopup = document.getElementById('ear-popup');
            const manePopup = document.getElementById('mane-popup');
            const closeButtons = document.querySelectorAll('.popup-close');
            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    earPopup.style.display = 'none';
                    manePopup.style.display = 'none';
                });
            });
            document.addEventListener('click', (e) => {
                if (e.target === document.body || e.target === renderer.domElement) {
                    earPopup.style.display = 'none';
                    manePopup.style.display = 'none';
                }
            });

            // æ¨¡å‹åŠ è½½æ ¸å¿ƒé€»è¾‘ï¼ˆä¿®å¤è·¯å¾„ + è¶…æ—¶å¤„ç† + è¯¦ç»†é”™è¯¯åé¦ˆï¼‰
            const loader = new GLTFLoader();
            let model = null;
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            // ğŸ”¥ å·²ç²¾å‡†åŒ¹é…ä½ çš„ä»“åº“è·¯å¾„ï¼ˆæ— éœ€ä¿®æ”¹ï¼Œç›´æ¥ç”¨ï¼‰ğŸ”¥
            // æ ¼å¼ï¼šhttps://ç”¨æˆ·å.github.io/ä»“åº“å/æ¨¡å‹æ–‡ä»¶å
            const modelUrl = 'https://clara1210.github.io/Yuan-Ming-yuan/3dmodel.glb';

            // è®¾ç½®åŠ è½½è¶…æ—¶ï¼ˆ15ç§’æœªåŠ è½½å®Œæˆæç¤ºç½‘ç»œé—®é¢˜ï¼‰
            const timeoutTimer = setTimeout(() => {
                loadingText.innerText = 'ç½‘ç»œåŠ è½½è¶…æ—¶ï¼Œç‚¹å‡»é‡è¯•';
                console.error('æ¨¡å‹åŠ è½½è¶…æ—¶ï¼šå¯èƒ½æ˜¯ç½‘ç»œä¸ç¨³å®šæˆ–è·¯å¾„é”™è¯¯');
            }, 15000);

            loader.load(
                modelUrl,
                (gltf) => {
                    clearTimeout(timeoutTimer); // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
                    model = gltf.scene;
                    model.scale.set(3.8, 3.8, 3.8);
                    model.position.set(0, -0.6, 0);
                    model.rotation.y = -Math.PI / 4;
                    scene.add(model);
                    loadingText.style.display = 'none';

                    // æ ‡è®°å¯ç‚¹å‡»Mesh
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.userData.clickable = true;
                            child.renderOrder = 1;
                        }
                    });
                },
                (xhr) => {
                    // å®æ—¶æ˜¾ç¤ºåŠ è½½è¿›åº¦ï¼ˆè®©ç”¨æˆ·æ˜ç¡®çŸ¥é“åœ¨åŠ è½½ï¼‰
                    const progress = (xhr.loaded / xhr.total * 100).toFixed(0);
                    loadingText.innerText = `åŠ è½½ä¸­...${progress}%`;
                },
                (error) => {
                    clearTimeout(timeoutTimer);
                    console.error('æ¨¡å‹åŠ è½½å¤±è´¥è¯¦ç»†åŸå› ï¼š', error);
                    // æ ¹æ®é”™è¯¯ç±»å‹æ˜¾ç¤ºå¯¹åº”æç¤º
                    if (error.message.includes('404')) {
                        loadingText.innerText = 'æ¨¡å‹æ–‡ä»¶æœªæ‰¾åˆ°ï¼ˆè·¯å¾„é”™è¯¯ï¼‰ï¼Œç‚¹å‡»é‡è¯•';
                    } else if (error.message.includes('CORS')) {
                        loadingText.innerText = 'è·¨åŸŸé”™è¯¯ï¼ˆå°ç¨‹åºåŸŸåæœªé…ç½®ï¼‰ï¼Œç‚¹å‡»é‡è¯•';
                    } else {
                        loadingText.innerText = 'åŠ è½½å¤±è´¥ï¼Œç‚¹å‡»é‡è¯•';
                    }
                    loadingText.addEventListener('click', () => window.location.reload());
                }
            );

            // ç›¸æœºä¸æ§åˆ¶å™¨ï¼ˆé€‚é…å°ç¨‹åºè§¦æ‘¸ï¼‰
            camera.position.z = 5.5;
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.autoRotate = false;
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableRotate = true;
            controls.enableZoom = true;
            controls.minDistance = 3;
            controls.maxDistance = 7;
            controls.touches = {
                ONE: THREE.TOUCH.ROTATE,
                TWO: THREE.TOUCH.DOLLY_PAN
            };
            controls.reset();

            // ç‚¹å‡»/è§¦æ‘¸äº‹ä»¶å¤„ç†
            function onPointerDown(e) {
                if (!model) return;

                let clientX, clientY;
                if (e.type === 'touchstart') {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                mouse.x = (clientX / window.innerWidth) * 2 - 1;
                mouse.y = - (clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(model.children, true);

                if (intersects.length > 0) {
                    const clickedObject = intersects[0].object;
                    const worldPosition = new THREE.Vector3();
                    clickedObject.getWorldPosition(worldPosition);

                    const isLeftEar = worldPosition.x < -1.0 && worldPosition.y > 0.3 && worldPosition.z > -0.8;
                    const isRightEar = worldPosition.x > 1.0 && worldPosition.y > 0.3 && worldPosition.z > -0.8;
                    const isMane = worldPosition.x > -1.2 && worldPosition.x < 1.2 && worldPosition.y < 0.6 && worldPosition.y > -0.5;

                    if (isLeftEar || isRightEar) {
                        earPopup.style.display = 'block';
                        manePopup.style.display = 'none';
                    } else if (isMane) {
                        manePopup.style.display = 'block';
                        earPopup.style.display = 'none';
                    } else {
                        earPopup.style.display = 'none';
                        manePopup.style.display = 'none';
                    }
                }
            }

            window.addEventListener('click', onPointerDown);
            window.addEventListener('touchstart', onPointerDown);

            // çª—å£è‡ªé€‚åº”
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // åŠ¨ç”»å¾ªç¯
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }
            animate();
        }
    </script>
</body>
</html>
