<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>圆明园构件3D展示</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; background: #fff !important; font-family: "Microsoft YaHei", sans-serif; }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 20px;
            z-index: 999;
            text-align: center;
        }
        #model-desc {
            position: fixed;
            bottom: 40px;
            left: 20px;
            right: 20px;
            z-index: 99;
            color: #000;
            font-size: 17px;
            line-height: 1.6;
            letter-spacing: 0.5px;
        }
        .popup-desc {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 999;
            background: rgba(255,255,255,0.95);
            color: #000;
            font-size: 16px;
            line-height: 1.5;
            padding: 18px 20px;
            border-radius: 12px;
            max-width: 85%;
            box-shadow: 0 3px 18px rgba(0,0,0,0.15);
            display: none;
        }
        .popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 22px;
            color: #666;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        /* 强制画布占满屏幕，避免渲染异常 */
        #three-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
    </style>
    <!-- 直接引入完整Three.js，避免CDN拦截（核心修复） -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/GLTFLoader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.min.js"></script>
</head>
<body>
    <div id="three-container"></div>
    <div class="loading">加载中...</div>
    <div id="model-desc">
        它不只是一件文物，更是一座‘百年水力钟’！马首作为海晏堂十二生肖水力钟的核心，专门对应午时（11:00-13:00）喷水，中西合璧的水利与计时智慧，在它身上体现得淋漓尽致。
    </div>
    <div class="popup-desc" id="ear-popup">
        <button class="popup-close">&times;</button>
        仔细看！这处残缺的右耳，藏着一段刻骨铭心的历史——1860年英法联军劫掠圆明园时，它被暴力损毁，成为文物百年流离的“无声见证者”。今天，就让我们用数字技术，为它补上这道跨越百年的“伤痕”。
    </div>
    <div class="popup-desc" id="mane-popup">
        <button class="popup-close">&times;</button>
        这组灵动的卷曲鬃毛，竟出自郎世宁之手！它将西洋雕塑的写实细腻，与中国青铜工艺的厚重典雅完美融合，每一缕纹路都藏着清代宫廷造办处的巅峰技艺，历经百年依旧灵动鲜活。
    </div>

    <script>
        // 全局变量（改用原生JS，移除module模式，避免解析错误）
        let scene, camera, renderer, model, raycaster, mouse, controls;
        const loadingText = document.querySelector('.loading');
        const container = document.getElementById('three-container');
        // 适配GitHub Pages的绝对路径模板（替换成你的GitHub信息即可）
        const GITHUB_USER = 'clara1210'; // 例：const GITHUB_USER = 'zhangsan';
        const GITHUB_REPO = 'Yuan-Ming-yuan';
        // 模型双路径（带空格/无空格都适配，无需修改）
        const MODEL_URL1 = `https://${GITHUB_USER}.github.io/${GITHUB_REPO}/3d%20model.glb`;
        const MODEL_URL2 = `https://${GITHUB_USER}.github.io/${GITHUB_REPO}/3dmodel.glb`;

        // 初始化3D场景（底层重构，避免渲染异常）
        function initScene() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 5;

            // 渲染器配置（强制适配移动端）
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0xffffff);
            renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(renderer.domElement);

            // 光照（增强模型显示，避免黑块）
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
            const dirLight1 = new THREE.DirectionalLight(0xffffff, 0.6);
            dirLight1.position.set(3, 5, 4);
            const dirLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
            dirLight2.position.set(-3, -5, -4);
            scene.add(ambientLight, dirLight1, dirLight2);

            // 控制器（适配手机触摸，禁用多余效果）
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 2;
            controls.maxDistance = 8;
            controls.autoRotate = false;
            controls.enablePan = false;
            controls.touches = { ONE: THREE.TOUCH.ROTATE, TWO: THREE.TOUCH.DOLLY_PAN };

            // 射线检测（点击交互核心）
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // 窗口自适应
            window.addEventListener('resize', onWindowResize);
            // 绑定点击/触摸事件
            window.addEventListener('click', onPointerDown);
            window.addEventListener('touchstart', onPointerDown);
        }

        // 加载模型（双路径自动重试，新增详细错误提示）
        function loadModel(url) {
            const loader = new THREE.GLTFLoader();
            const timeout = setTimeout(() => {
                loadingText.innerText = '加载超时，正在重试...';
                loadModel(url === MODEL_URL1 ? MODEL_URL2 : MODEL_URL1);
            }, 15000);

            loader.load(
                url,
                (gltf) => {
                    clearTimeout(timeout);
                    model = gltf.scene;
                    model.scale.set(3.5, 3.5, 3.5);
                    model.position.set(0, -0.5, 0);
                    model.rotation.y = -Math.PI / 4;
                    scene.add(model);
                    loadingText.style.display = 'none';
                    console.log('模型加载成功！');
                },
                (xhr) => {
                    const progress = Math.floor((xhr.loaded / xhr.total) * 100);
                    loadingText.innerText = `加载中...${progress}%`;
                },
                (error) => {
                    clearTimeout(timeout);
                    console.error('模型加载失败：', error);
                    // 路径1失败自动试路径2，都失败则提示
                    if (url === MODEL_URL1) {
                        loadingText.innerText = '路径1失败，尝试路径2...';
                        loadModel(MODEL_URL2);
                    } else {
                        loadingText.innerText = '加载失败！检查文件名/用户名';
                        loadingText.style.color = '#ff4d4f';
                        // 点击手动重试
                        loadingText.addEventListener('click', () => {
                            loadingText.style.color = '#000';
                            loadModel(MODEL_URL1);
                        });
                    }
                }
            );
        }

        // 窗口自适应
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // 点击/触摸交互（精准识别，适配模型角度）
        function onPointerDown(e) {
            if (!model) return;
            e.preventDefault();

            // 坐标转换（兼容手机/电脑）
            let clientX, clientY;
            if (e.type === 'touchstart') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);

            // 检测模型点击
            const intersects = raycaster.intersectObjects(model.children, true);
            if (intersects.length > 0) {
                const pos = intersects[0].object.getWorldPosition(new THREE.Vector3());
                // 耳朵/鬓毛识别范围（放大适配，更易点击）
                const isEar = (pos.x < -1.0 || pos.x > 1.0) && pos.y > 0.3 && pos.z > -0.6;
                const isMane = pos.x > -1.0 && pos.x < 1.0 && pos.y > -0.4 && pos.y < 0.6;

                if (isEar) {
                    document.getElementById('ear-popup').style.display = 'block';
                    document.getElementById('mane-popup').style.display = 'none';
                } else if (isMane) {
                    document.getElementById('mane-popup').style.display = 'block';
                    document.getElementById('ear-popup').style.display = 'none';
                } else {
                    document.getElementById('ear-popup').style.display = 'none';
                    document.getElementById('mane-popup').style.display = 'none';
                }
            } else {
                // 点击空白处关闭弹窗
                document.getElementById('ear-popup').style.display = 'none';
                document.getElementById('mane-popup').style.display = 'none';
            }
        }

        // 弹窗关闭逻辑
        document.querySelectorAll('.popup-close').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('ear-popup').style.display = 'none';
                document.getElementById('mane-popup').style.display = 'none';
            });
        });

        // 动画循环（保证流畅渲染）
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // 启动程序（核心入口，先初始化再加载）
        window.onload = function() {
            initScene();
            loadModel(MODEL_URL1);
            animate();
        };
    </script>
</body>
</html>
