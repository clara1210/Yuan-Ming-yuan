<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>圆明园构件3D展示</title>
    <style>
        body { margin: 0; overflow: hidden; background: #fff !important; }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 20px;
            z-index: 100;
        }
        /* 底部文字：左对齐、占满屏幕、手机清晰显示 */
        #model-desc {
            position: fixed;
            bottom: 20px; /* 适配小程序底部安全区 */
            left: 15px;
            right: 15px;
            z-index: 9;
            background: transparent;
            color: #000;
            font-size: 16px;
            line-height: 1.5;
            text-align: left;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0;
        }
        /* 顶部弹窗：适配小程序，优化触摸体验 */
        .popup-desc {
            position: fixed;
            top: 20px;
            left: 15px;
            right: 15px;
            z-index: 99;
            background: rgba(255, 255, 255, 0.98);
            color: #000;
            font-size: 15px;
            line-height: 1.5;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            display: none;
        }
        .popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            color: #999;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        .popup-close:active { color: #000; }
    </style>
    <!-- 小程序兼容的Three.js CDN（国内节点，避免跨域） -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.staticfile.org/three.js/0.160.0/three.module.js",
                "three/addons/": "https://cdn.staticfile.org/three.js/0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div class="loading">加载中...</div>
    <!-- 底部左对齐说明文字 -->
    <div id="model-desc">
        它不只是一件文物，更是一座‘百年水力钟’！马首作为海晏堂十二生肖水力钟的核心，专门对应午时（11:00-13:00）喷水，中西合璧的水利与计时智慧，在它身上体现得淋漓尽致。
    </div>
    <!-- 耳朵点击弹窗（左右耳共用） -->
    <div class="popup-desc" id="ear-popup">
        <button class="popup-close">&times;</button>
        仔细看！这处残缺的右耳，藏着一段刻骨铭心的历史——1860年英法联军劫掠圆明园时，它被暴力损毁，成为文物百年流离的“无声见证者”。今天，就让我们用数字技术，为它补上这道跨越百年的“伤痕”。
    </div>
    <!-- 鬓毛点击弹窗 -->
    <div class="popup-desc" id="mane-popup">
        <button class="popup-close">&times;</button>
        这组灵动的卷曲鬃毛，竟出自郎世宁之手！它将西洋雕塑的写实细腻，与中国青铜工艺的厚重典雅完美融合，每一缕纹路都藏着清代宫廷造办处的巅峰技艺，历经百年依旧灵动鲜活。
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // 全局变量初始化
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0xffffff);
        document.body.appendChild(renderer.domElement);

        // 优化光照（提升模型轮廓，便于点击识别）
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
        const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.6);
        directionalLight1.position.set(3, 3, 3);
        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.4);
        directionalLight2.position.set(-3, -3, -3);
        scene.add(ambientLight, directionalLight1, directionalLight2);

        // 弹窗元素获取与关闭逻辑
        const earPopup = document.getElementById('ear-popup');
        const manePopup = document.getElementById('mane-popup');
        const closeButtons = document.querySelectorAll('.popup-close');

        closeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                earPopup.style.display = 'none';
                manePopup.style.display = 'none';
            });
        });

        // 点击空白处关闭弹窗
        document.addEventListener('click', (e) => {
            if (e.target === document.body || e.target === renderer.domElement) {
                earPopup.style.display = 'none';
                manePopup.style.display = 'none';
            }
        });

        // 模型加载与核心交互逻辑
        const loader = new GLTFLoader();
        const loadingText = document.querySelector('.loading');
        let model = null;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // 核心修改：模型路径改为重命名后的 3dmodel.glb（无空格）
        loader.load(
            './3dmodel.glb',
            (gltf) => {
                model = gltf.scene;
                model.scale.set(3.8, 3.8, 3.8); // 适配小程序显示比例
                model.position.set(0, -0.6, 0);
                model.rotation.y = -Math.PI / 4; // 向左转45°
                scene.add(model);
                loadingText.style.display = 'none';

                // 标记所有Mesh为可点击，提升渲染优先级
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.userData.clickable = true;
                        child.renderOrder = 1; // 避免点击检测穿透
                    }
                });
            },
            (xhr) => {
                // 显示加载进度，提升用户体验
                loadingText.innerText = `加载中...${(xhr.loaded / xhr.total * 100).toFixed(0)}%`;
            },
            (error) => {
                console.error('模型加载失败：', error);
                loadingText.innerText = '加载失败，请刷新重试';
            }
        );

        // 相机与控制器配置（适配手机/小程序触摸）
        camera.position.z = 5.5;
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.autoRotate = false;
        controls.enableDamping = true;
        controls.dampingFactor = 0.05; // 提升触摸顺滑度
        controls.enableRotate = true;
        controls.enableZoom = true;
        controls.minDistance = 3;
        controls.maxDistance = 7;
        controls.touches = {
            ONE: THREE.TOUCH.ROTATE,
            TWO: THREE.TOUCH.DOLLY_PAN
        };
        controls.reset();

        // 点击/触摸事件处理（优化小程序适配和识别范围）
        function onPointerDown(e) {
            if (!model) return;

            // 坐标转换（兼容小程序web-view视口）
            let clientX, clientY;
            if (e.type === 'touchstart') {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = - (clientY / window.innerHeight) * 2 + 1;

            // 射线检测点击部位
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(model.children, true);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                const worldPosition = new THREE.Vector3();
                clickedObject.getWorldPosition(worldPosition);

                // 扩大识别范围，适配模型偏移（小程序中更易点击）
                const isLeftEar = worldPosition.x < -1.0 && worldPosition.y > 0.3 && worldPosition.z > -0.8;
                const isRightEar = worldPosition.x > 1.0 && worldPosition.y > 0.3 && worldPosition.z > -0.8;
                const isMane = worldPosition.x > -1.2 && worldPosition.x < 1.2 && worldPosition.y < 0.6 && worldPosition.y > -0.5;

                // 弹窗触发逻辑
                if (isLeftEar || isRightEar) {
                    earPopup.style.display = 'block';
                    manePopup.style.display = 'none';
                } else if (isMane) {
                    manePopup.style.display = 'block';
                    earPopup.style.display = 'none';
                } else {
                    earPopup.style.display = 'none';
                    manePopup.style.display = 'none';
                }
            }
        }

        // 绑定交互事件（兼容点击和触摸）
        window.addEventListener('click', onPointerDown);
        window.addEventListener('touchstart', onPointerDown);

        // 窗口自适应（适配小程序旋转屏幕）
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // 动画循环（保证小程序中流畅运行）
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
