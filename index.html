<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>圆明园构件3D展示</title>
    <style>
        body { margin: 0; overflow: hidden; background: #fff !important; }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #000;
            font-size: 20px;
            z-index: 100;
            cursor: pointer;
        }
        /* 底部左对齐说明文字（保持原界面风格） */
        #model-desc {
            position: fixed;
            bottom: 40px;
            left: 20px;
            right: 20px;
            z-index: 9;
            background: transparent;
            color: #000;
            font-size: 17px;
            line-height: 1.6;
            text-align: left;
            padding: 0;
            font-family: "Microsoft YaHei", sans-serif;
            margin: 0;
            letter-spacing: 0.5px;
        }
        /* 顶部弹窗（原界面半透明风格，不挡模型） */
        .popup-desc {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99;
            background: rgba(255, 255, 255, 0.95);
            color: #000;
            font-size: 16px;
            line-height: 1.5;
            padding: 18px 20px;
            border-radius: 12px;
            max-width: 85%;
            text-align: left;
            font-family: "Microsoft YaHei", sans-serif;
            box-shadow: 0 3px 18px rgba(0,0,0,0.15);
            display: none;
        }
        .popup-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 22px;
            color: #666;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
        }
        .popup-close:hover {
            color: #000;
        }
        /* 新增加载失败提示样式 */
        .error-tip {
            color: #ff4d4f;
            font-size: 18px;
        }
    </style>
    <!-- 稳定CDN配置（优先原可用节点，备用国内节点） -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <!-- CDN失效自动切换 -->
    <script>
        window.addEventListener('error', (e) => {
            if (e.message.includes('Failed to fetch') && e.filename.includes('jsdelivr')) {
                console.warn('CDN切换到国内节点');
                const importMap = document.createElement('script');
                importMap.type = 'importmap';
                importMap.textContent = JSON.stringify({
                    "imports": {
                        "three": "https://cdn.byteintl.com/three.js/0.160.0/three.module.js",
                        "three/addons/": "https://cdn.byteintl.com/three.js/0.160.0/examples/jsm/"
                    }
                });
                document.head.appendChild(importMap);
                setTimeout(() => window.location.reload(), 500);
            }
        });
    </script>
</head>
<body>
    <div class="loading">加载中...</div>
    <!-- 底部说明文字（保持原内容） -->
    <div id="model-desc">
        它不只是一件文物，更是一座‘百年水力钟’！马首作为海晏堂十二生肖水力钟的核心，专门对应午时（11:00-13:00）喷水，中西合璧的水利与计时智慧，在它身上体现得淋漓尽致。
    </div>
    <!-- 耳朵点击弹窗（原内容不变） -->
    <div class="popup-desc" id="ear-popup">
        <button class="popup-close">&times;</button>
        仔细看！这处残缺的右耳，藏着一段刻骨铭心的历史——1860年英法联军劫掠圆明园时，它被暴力损毁，成为文物百年流离的“无声见证者”。今天，就让我们用数字技术，为它补上这道跨越百年的“伤痕”。
    </div>
    <!-- 鬓毛点击弹窗（原内容不变） -->
    <div class="popup-desc" id="mane-popup">
        <button class="popup-close">&times;</button>
        这组灵动的卷曲鬃毛，竟出自郎世宁之手！它将西洋雕塑的写实细腻，与中国青铜工艺的厚重典雅完美融合，每一缕纹路都藏着清代宫廷造办处的巅峰技艺，历经百年依旧灵动鲜活。
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // 全局变量初始化（沿用原成功配置）
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setClearColor(0xffffff);
        document.body.appendChild(renderer.domElement);

        // 光照配置（保持原质感）
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(5, 5, 5);
        scene.add(ambientLight, directionalLight);

        // 弹窗逻辑（原交互不变）
        const earPopup = document.getElementById('ear-popup');
        const manePopup = document.getElementById('mane-popup');
        const closeButtons = document.querySelectorAll('.popup-close');
        closeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                earPopup.style.display = 'none';
                manePopup.style.display = 'none';
            });
        });
        document.addEventListener('click', (e) => {
            if (e.target === document.body || e.target === renderer.domElement) {
                earPopup.style.display = 'none';
                manePopup.style.display = 'none';
            }
        });

        // 模型加载核心逻辑（稳定加载优化）
        const loader = new GLTFLoader();
        const loadingText = document.querySelector('.loading');
        let model = null;
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // 模型路径（兼容两种文件名，避免路径错误）
        const modelPaths = ['./3d%20model.glb', './3dmodel.glb'];
        let currentPathIndex = 0;

        // 加载函数（路径失败自动切换）
        function loadModel() {
            const currentPath = modelPaths[currentPathIndex];
            const timeoutTimer = setTimeout(() => {
                loadingText.innerText = '加载超时，点击重试';
            }, 12000);

            loader.load(
                currentPath,
                (gltf) => {
                    clearTimeout(timeoutTimer);
                    model = gltf.scene;
                    model.scale.set(3.5, 3.5, 3.5);
                    model.position.set(0, -0.5, 0);
                    model.rotation.y = -Math.PI / 4; // 原成功角度
                    scene.add(model);
                    loadingText.style.display = 'none';

                    // 标记可点击Mesh
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.userData.clickable = true;
                        }
                    });
                },
                (xhr) => {
                    const progress = (xhr.loaded / xhr.total * 100).toFixed(0);
                    loadingText.innerText = `加载中...${progress}%`;
                },
                (error) => {
                    clearTimeout(timeoutTimer);
                    console.error(`路径${currentPath}加载失败，尝试下一路径`, error);
                    currentPathIndex++;
                    if (currentPathIndex < modelPaths.length) {
                        loadingText.innerText = '切换模型路径...';
                        setTimeout(loadModel, 500);
                    } else {
                        loadingText.innerText = '加载失败，点击重试';
                        loadingText.classList.add('error-tip');
                        loadingText.addEventListener('click', () => {
                            currentPathIndex = 0;
                            loadingText.classList.remove('error-tip');
                            loadModel();
                        });
                    }
                }
            );
        }

        // 启动加载（兼容两种文件名）
        loadModel();

        // 相机与控制器（原交互配置不变）
        camera.position.z = 5;
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.autoRotate = false;
        controls.enableDamping = true;
        controls.enableRotate = true;
        controls.enableZoom = true;
        controls.minDistance = 2;
        controls.maxDistance = 8;
        controls.touches = {
            ONE: THREE.TOUCH.ROTATE,
            TWO: THREE.TOUCH.DOLLY_PAN
        };
        controls.reset();

        // 点击识别逻辑（原精准范围不变）
        function onPointerDown(e) {
            if (!model) return;

            // 坐标转换（兼容手机/电脑）
            if (e.type === 'touchstart') {
                const touch = e.touches[0];
                mouse.x = (touch.clientX / window.innerWidth) * 2 - 1;
                mouse.y = - (touch.clientY / window.innerHeight) * 2 + 1;
            } else {
                mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                mouse.y = - (e.clientY / window.innerHeight) * 2 + 1;
            }

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(model.children, true);

            if (intersects.length > 0) {
                const clickedObject = intersects[0].object;
                const worldPosition = new THREE.Vector3();
                clickedObject.getWorldPosition(worldPosition);

                // 原识别范围（左耳/右耳/鬓毛）
                const isLeftEar = worldPosition.x < -1.2 && worldPosition.y > 0.5 && worldPosition.z > -0.5;
                const isRightEar = worldPosition.x > 1.2 && worldPosition.y > 0.5 && worldPosition.z > -0.5;
                const isMane = worldPosition.x > -0.8 && worldPosition.x < 0.8 && worldPosition.y < 0.5 && worldPosition.y > -0.3;

                if (isLeftEar || isRightEar) {
                    earPopup.style.display = 'block';
                    manePopup.style.display = 'none';
                } else if (isMane) {
                    manePopup.style.display = 'block';
                    earPopup.style.display = 'none';
                } else {
                    earPopup.style.display = 'none';
                    manePopup.style.display = 'none';
                }
            }
        }

        // 绑定交互事件
        window.addEventListener('click', onPointerDown);
        window.addEventListener('touchstart', onPointerDown);

        // 窗口自适应
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>
</html>
