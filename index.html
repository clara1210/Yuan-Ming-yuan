<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>圆明园构件3D展示</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family: Arial, sans-serif; background:#f0f0f0;}
button{cursor:pointer; transition:0.3s;}
button:hover{transform:scale(1.05);}

/* 选择页面 */
#selectPage{
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:30px;
    transition:opacity 0.5s;
}
.select-btn{
    padding:20px 60px;
    font-size:24px;
    border:none;
    border-radius:12px;
    background:#b8860b;
    color:#fff;
    font-weight:bold;
}
.select-btn:hover{background:#d4af37;}

/* 3D 展示页面 */
#viewerPage{
    display:none;
    min-height:100vh;
    flex-direction:column;
    align-items:center;
    padding:20px;
    position:relative;
    transition:opacity 0.5s;
}
#backBtn{
    position:absolute;
    top:20px;
    left:20px;
    padding:10px 20px;
    font-size:16px;
    border:none;
    border-radius:6px;
    background:#b8860b;
    color:#fff;
    font-weight:bold;
}
#backBtn:hover{background:#d4af37;}

.model-container{
    width:100%;
    max-width:900px;
    height:75vh;
    border-radius:15px;
    overflow:hidden;
    position:relative;
    margin-bottom:20px;
    box-shadow:0 30px 60px rgba(0,0,0,0.3);
}
#modelCanvas{width:100%; height:100%; display:block;}

.loading{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    font-size:16px;
    color:#666;
    z-index:10;
}
#loadingBarContainer{
    width:200px;
    height:10px;
    background:#ccc;
    border-radius:5px;
    overflow:hidden;
    margin-top:5px;
}
#loadingBar{
    width:0%;
    height:100%;
    background:#b8860b;
}

.introduction{
    width:100%;
    max-width:900px;
    padding:30px;
    text-align:center;
    font-size:16px;
    font-weight:bold;
    background:rgba(255,255,255,0.95);
    border-radius:15px;
    line-height:1.7;
    white-space:pre-line;
    opacity:0;
    transition:opacity 0.6s ease;
}
.introduction.show{opacity:1;}

.controls,.part-buttons{
    margin-top:20px;
    display:flex;
    gap:10px;
    justify-content:center;
}
.control-btn,.part-btn{
    padding:8px 16px;
    border-radius:4px;
    cursor:pointer;
}
.control-btn{border:none;background:#ffffff;}
.part-btn{
    background:#b8860b;
    border:none;
    color:#fff;
    font-weight:bold;
}
.part-btn:hover{background:#d4af37;}
</style>
</head>
<body>

<!-- 选择页面 -->
<div id="selectPage">
    <button class="select-btn" onclick="startViewer('horse')">马首</button>
    <button class="select-btn" onclick="startViewer('tiger')">虎首</button>
</div>

<!-- 3D 展示页面 -->
<div id="viewerPage" class="container">
    <button id="backBtn" onclick="returnToSelect()">返回选择</button>

    <div class="model-container">
        <div class="loading" id="loading">
            <div>加载中...</div>
            <div id="loadingBarContainer">
                <div id="loadingBar"></div>
            </div>
        </div>
        <canvas id="modelCanvas"></canvas>
    </div>

    <div class="introduction" id="introText"></div>

    <div class="controls">
        <button class="control-btn" onclick="resetCamera()">重置视角</button>
        <button class="control-btn" onclick="zoomIn()">放大</button>
        <button class="control-btn" onclick="zoomOut()">缩小</button>
        <button class="control-btn" onclick="toggleAutoRotate()">自动旋转开关</button>
        <button class="control-btn" onclick="setCameraView('front')">正面</button>
        <button class="control-btn" onclick="setCameraView('side')">侧面</button>
        <button class="control-btn" onclick="setCameraView('top')">俯视</button>
        <button class="control-btn" onclick="changeLighting('default')">默认光</button>
        <button class="control-btn" onclick="changeLighting('warm')">暖光</button>
        <button class="control-btn" onclick="changeLighting('cold')">冷光</button>
    </div>

    <div class="part-buttons" id="partButtons"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>

<script>
let scene, camera, renderer, controls, model;
let autoRotate = true;
let currentModel = ''; // horse 或 tiger

// 页面切换
function fadeOut(el, callback){
    el.style.opacity = 1;
    const fade = setInterval(()=>{
        el.style.opacity -= 0.05;
        if(el.style.opacity <=0){
            clearInterval(fade);
            el.style.display='none';
            if(callback) callback();
        }
    },20);
}
function fadeIn(el){
    el.style.display='flex';
    el.style.opacity = 0;
    const fade = setInterval(()=>{
        el.style.opacity = Math.min(parseFloat(el.style.opacity)+0.05,1);
        if(el.style.opacity>=1) clearInterval(fade);
    },20);
}

// 点击选择按钮
function startViewer(type){
    currentModel = type;
    fadeOut(document.getElementById('selectPage'), ()=>{
        fadeIn(document.getElementById('viewerPage'));
        setupPartButtons();
        init();
        animate();
        showIntroduction();
    });
}

// 返回选择页面
function returnToSelect(){
    fadeOut(document.getElementById('viewerPage'), ()=>{
        fadeIn(document.getElementById('selectPage'));
        if(model) scene.remove(model);
        model=null;
    });
}

// 部件按钮
function setupPartButtons(){
    const container = document.getElementById('partButtons');
    container.innerHTML='';
    if(currentModel==='horse'){
        container.innerHTML=`
            <button class="part-btn" onclick="showIntroduction('mane')">鬓毛</button>
            <button class="part-btn" onclick="showIntroduction('ear')">耳朵</button>
            <button class="part-btn" onclick="showIntroduction('material')">材质</button>
            <button class="part-btn" onclick="loadOldModel()">修复前的马首</button>
            <button class="part-btn" onclick="loadNewModel()">修复后的马首</button>
        `;
    } else if(currentModel==='tiger'){
        container.innerHTML=`
            <button class="part-btn" onclick="showIntroduction('forehead')">前额</button>
            <button class="part-btn" onclick="showIntroduction('eyes')">眼部神态</button>
            <button class="part-btn" onclick="showIntroduction('nose')">鼻部与面部肌肉</button>
            <button class="part-btn" onclick="loadOldModel()">修复前的虎首</button>
            <button class="part-btn" onclick="loadNewModel()">修复后的虎首</button>
        `;
    }
}

// Three.js 初始化
function init(){
    scene = new THREE.Scene();

    const canvas = document.createElement('canvas');
    canvas.width=2; canvas.height=512;
    const ctx = canvas.getContext('2d');
    const gradient = ctx.createLinearGradient(0,0,0,512);
    gradient.addColorStop(0,'#f7f7f7');
    gradient.addColorStop(1,'#e6e6e6');
    ctx.fillStyle=gradient;
    ctx.fillRect(0,0,2,512);
    scene.background = new THREE.CanvasTexture(canvas);

    camera = new THREE.PerspectiveCamera(60,1,0.1,1000);
    camera.position.set(0,1,6);

    const container = document.querySelector('.model-container');
    renderer = new THREE.WebGLRenderer({canvas: document.getElementById('modelCanvas'), antialias:true});
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    addLighting();

    const groundGeo = new THREE.PlaneGeometry(20,20);
    const groundMat = new THREE.ShadowMaterial({opacity:0.3});
    const ground = new THREE.Mesh(groundGeo,groundMat);
    ground.rotation.x=-Math.PI/2;
    ground.position.y=-1.5;
    ground.receiveShadow = true;
    scene.add(ground);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = false;
    controls.addEventListener('start',()=>autoRotate=false);
    controls.addEventListener('end',()=>autoRotate=true);

    if(currentModel==='horse') loadModel('horse model.glb');
    else if(currentModel==='tiger') loadModel('tiger.glb');

    window.addEventListener('resize', onWindowResize);
}

// 光照控制
function addLighting(type='default'){
    scene.children.filter(obj=>obj.isLight).forEach(obj=>scene.remove(obj));
    let light = new THREE.DirectionalLight(0xffffff,1);
    if(type==='warm') light.color = new THREE.Color(0xffddaa);
    if(type==='cold') light.color = new THREE.Color(0xaaffff);
    light.position.set(5,10,5);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0xffffff,0.5));
}
function changeLighting(type){ addLighting(type); }

// 加载模型 + 进度条
function loadModel(url){
    const loader = new THREE.GLTFLoader();
    const loadingBar = document.getElementById('loadingBar');
    document.getElementById('loading').style.display='block';

    loader.load(url,
        function(gltf){
            if(model) scene.remove(model);
            model = gltf.scene;
            model.traverse(obj=>{if(obj.isMesh){obj.castShadow=true;obj.receiveShadow=false;}});
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            model.position.sub(center);
            model.traverse(obj=>{if(obj.material)obj.material.transparent=true; obj.material.opacity=0;});
            scene.add(model);

            // 淡入动画
            let opacity = 0;
            const fadeIn = setInterval(()=>{
                opacity += 0.05;
                model.traverse(obj=>{if(obj.material)obj.material.opacity=opacity;});
                if(opacity>=1) clearInterval(fadeIn);
            },30);

            document.getElementById('loading').style.display='none';
        },
        function(xhr){
            const percent = (xhr.loaded / xhr.total)*100;
            loadingBar.style.width = percent+'%';
        },
        function(error){ alert('模型加载失败'); console.error(error);}
    );
}

// 切换模型（修复前/后）
function loadOldModel(){ transitionModel(currentModel==='horse'?'horse model.glb':'tiger model.glb'); }
function loadNewModel(){ transitionModel(currentModel==='horse'?'horse.glb':'tiger.glb'); }

function transitionModel(newUrl){
    if(!model) return loadModel(newUrl);
    let opacity = 1;
    const fadeOut = setInterval(()=>{
        opacity -= 0.05;
        model.traverse(obj=>{if(obj.material)obj.material.opacity=opacity;});
        if(opacity<=0){
            clearInterval(fadeOut);
            scene.remove(model);
            loadModel(newUrl);
            showIntroduction();
        }
    },30);
}

// 动画循环
function animate(){
    requestAnimationFrame(animate);
    if(model && autoRotate) model.rotation.y += 0.003;
    controls.update();
    renderer.render(scene,camera);
}

// 自适应窗口
function onWindowResize(){
    const container = document.querySelector('.model-container');
    camera.aspect = container.clientWidth/container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

// 相机控制
function resetCamera(){camera.position.set(0,1,6); controls.target.set(0,0,0); controls.update();}
function zoomIn(){camera.position.z *=0.85;}
function zoomOut(){camera.position.z *=1.15;}
function toggleAutoRotate(){autoRotate = !autoRotate; alert('自动旋转 '+(autoRotate?'开启':'关闭'));}
function setCameraView(view){
    if(view==='front') camera.position.set(0,1,6);
    if(view==='side') camera.position.set(6,1,0);
    if(view==='top') camera.position.set(0,10,0);
    controls.target.set(0,0,0);
    controls.update();
}

// 简介文字打字机效果（保持原文字不变）
function showIntroduction(part){
    const intro = document.getElementById('introText');
    intro.classList.remove('show');
    let text='';

    if(currentModel==='horse'){
        text=`它不只是一件文物，更是一座“百年水力钟”！马首作为海晏堂十二生肖水力钟的核心，专门对应午时（11:00-13:00）喷水，中西合璧的水利与计时智慧，在它身上体现得淋漓尽致。
It is not just a cultural relic, but a century-old water clock!
As the centerpiece of the Twelve Chinese Zodiac Water Clock at the Haiyan Hall, the Horse Head spouts water specifically at the Wu hour (11:00–13:00).
The wisdom of water conservancy and timekeeping, a perfect fusion of Chinese and Western ingenuity, is vividly embodied in it.`;
        if(part==='mane') text=`这组灵动的卷曲鬃毛，竟出自郎世宁之手！它将西洋雕塑的写实细腻，与中国青铜工艺的厚重典雅完美融合，每一缕纹路都藏着清代宫廷造办处的巅峰技艺，历经百年依旧灵动鲜活。
These lively, curling manes are actually the work of Giuseppe Castiglione! They perfectly blend the realistic delicacy of Western sculpture with the solemn elegance of Chinese bronze craftsmanship. 
Every strand and pattern bears the supreme skill of the Qing court workshops, remaining vivid and vibrant even after a hundred years.`;
        if(part==='ear') text=`仔细看！这处残缺的右耳，藏着一段刻骨铭心的历史——1860年英法联军劫掠圆明园时，它被暴力损毁，成为文物百年流离的“无声见证者”。今天，就让我们用数字技术，为它补上这道跨越百年的“伤痕”。
Look closely! This damaged right ear holds a deeply unforgettable history.
In 1860, during the looting of the Old Summer Palace by Anglo-French forces, it was violently destroyed, becoming a silent witness to the relic’s century of displacement.
Today, let us use digital technology to mend this century-old scar.`;
        if(part==='material') text=`看似朴素的马首，藏着不简单的材质密码——它由98%高纯度红铜打造，搭配微量铅、铁、锌，与乾隆内务府档案记载的配方分毫不差，也正因如此，它才能历经百年风雨，依旧完好留存。
The seemingly simple Horse Head hides an extraordinary material secret.
Forged from 98% high-purity copper, with trace amounts of lead, iron, and zinc, its composition matches exactly the formula recorded in the archives of the Qianlong Imperial Household Department.
This is precisely why it has survived centuries of wind and rain and remained intact to this day.`;
    } else if(currentModel==='tiger'){
        text=`虎对应寅时（3:00—5:00），是黎明将至、万物苏醒之时。虎首每到寅时自动喷水，正午与十一兽首齐喷，是古人把生肖文化、计时文化、水利科技合为一体的绝妙设计。
The Tiger corresponds to the Yin hour (3:00–5:00), the time when dawn approaches and all living things stir.
The Tiger Head automatically spouts water at every Yin hour, and at noon, it sprays in unison with the other eleven animal heads.
This is an ingenious design by the ancient Chinese that integrates zodiac culture, timekeeping culture, and water conservancy technology.`;
        if(part==='forehead') text=`虎首额头特意铸有清晰的 “王” 字纹路 ，这是中国文化独有的艺术表达 —— 虎为百兽之王，“王” 字既是虎的标志，也象征威严、正气与守护，是中式图腾与西方雕塑完美融合的巧思。
The forehead of the Tiger Head is deliberately inscribed with the character "王", unique to Chinese culture — Tiger, as the king of beasts, the "王" symbolizes authority, righteousness, and protection, a clever fusion of Chinese totem and Western sculpture.`;
        if(part==='eyes') text=`虎首的眼神犀利如炬，每一处眼角雕刻都体现了清代造办处匠人的极致工艺——逼真、灵动、威猛，让观者仿佛能感受到虎的呼吸与生机。
The eyes of the Tiger Head are sharp like a torch. Every carving detail reflects the supreme craftsmanship of Qing dynasty artisans—realistic, lively, and powerful, giving viewers a sense of the tiger's breath and vitality.`;
        if(part==='nose') text=`虎首的鼻部与面部肌肉线条流畅且细腻，结合铜材的光泽，形成强烈的立体感和动感，体现出古代工匠对动物解剖结构的深刻理解与艺术呈现。
The nose and facial muscle lines of the Tiger Head are smooth and delicate. Combined with the copper's luster, they create a strong sense of three-dimensionality and motion, reflecting ancient craftsmen's profound understanding of animal anatomy and artistic expression.`;
    }

    intro.textContent='';
    intro.classList.add('show');
    let i=0;
    function typeWriter(){
        if(i<text.length){
            intro.textContent += text.charAt(i);
            i++;
            setTimeout(typeWriter,15);
        }
    }
    typeWriter();
}
</script>
</body>
</html>
